<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fitness Tracker (Walk + Strength + Push-ups)</title>
  <meta name="theme-color" content="#111111" />
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; background: #f6f7f9; color: #111; }
    header { padding: 16px; background: #111; color: #fff; }
    header h1 { margin: 0 0 6px; font-size: 18px; }
    header p { margin: 0; opacity: 0.8; font-size: 13px; }
    main { max-width: 1100px; margin: 0 auto; padding: 16px; }
    .banner {
      display:none; margin: 0 0 12px; padding: 12px;
      border-radius: 12px; border: 1px solid #fca5a5; background: #fff1f2;
      color:#7f1d1d; font-weight: 700;
    }
    .tabs { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px; }
    .tabbtn { border: 1px solid #d0d5dd; background: #fff; padding: 10px 12px;
      border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 14px; }
    .tabbtn.active { background: #111; color: #fff; border-color: #111; }
    .panel { display: none; }
    .panel.active { display: block; }
    .card { background: #fff; border: 1px solid #e5e7eb; border-radius: 14px;
      padding: 14px; margin-bottom: 14px; box-shadow: 0 1px 0 rgba(0,0,0,0.03); }
    .card h2 { margin: 0 0 10px; font-size: 16px; }
    .grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 10px; }
    .field { grid-column: span 6; }
    .field.sm { grid-column: span 3; }
    .field.lg { grid-column: span 12; }
    label { display: block; font-size: 12px; opacity: 0.8; margin: 2px 0 6px; }
    input, select, textarea, button {
      width: 100%; box-sizing: border-box; padding: 10px 10px;
      border: 1px solid #d0d5dd; border-radius: 10px; background: #fff; font-size: 14px;
    }
    textarea { min-height: 70px; resize: vertical; }
    button.primary { background: #111; color: #fff; border-color: #111; font-weight: 700; }
    button.danger { background: #b42318; color: #fff; border-color: #b42318; font-weight: 700; }
    button.muted { background: #f3f4f6; border-color: #d0d5dd; }
    .btnrow { display: flex; gap: 10px; flex-wrap: wrap; }
    .btnrow > * { flex: 1 1 180px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid #eef0f4; padding: 10px 8px; text-align: left; font-size: 13px; vertical-align: top; }
    th { font-size: 12px; opacity: 0.75; }
    .row-actions { display: flex; gap: 8px; }
    .small { font-size: 12px; opacity: 0.75; }
    .kpi { display: grid; grid-template-columns: repeat(12, 1fr); gap: 10px; }
    .kpi .box { grid-column: span 4; background: #fff; border: 1px solid #e5e7eb; border-radius: 14px; padding: 12px; }
    .kpi .box h3 { margin: 0 0 6px; font-size: 12px; opacity: 0.75; }
    .kpi .box .num { font-size: 22px; font-weight: 800; }
    .rule { padding: 10px; border-radius: 12px; background: #111; color: #fff; font-weight: 700; display: inline-block; }
    @media (max-width: 720px) { .field, .field.sm { grid-column: span 12; } .kpi .box { grid-column: span 12; } }
  </style>
</head>

<body>
<header>
  <h1>Fitness Tracker — Walk (3×/wk) + Strength (2×/wk) + Push-ups</h1>
  <p>Offline-ish. Data saved in your browser. Export weekly.</p>
</header>

<main>
  <div id="errBanner" class="banner"></div>

  <div class="tabs">
    <button class="tabbtn active" data-tab="overview">Overview</button>
    <button class="tabbtn" data-tab="walks">Walking Log</button>
    <button class="tabbtn" data-tab="strength">Strength Log</button>
    <button class="tabbtn" data-tab="pushups">Push-up Progress</button>
    <button class="tabbtn" data-tab="backup">Backup / Reset</button>
  </div>

  <section id="overview" class="panel active">
    <div class="card">
      <h2>Weekly plan (simple, repeatable)</h2>
      <div class="small">Consistency beats intensity.</div>
      <div style="margin:10px 0 12px;">
        <span class="rule">Rule: Never miss twice.</span>
      </div>
      <ul class="small" style="line-height:1.6; margin-top: 10px;">
        <li><b>Mon</b> Walk (30–60 min)</li>
        <li><b>Tue</b> Strength</li>
        <li><b>Wed</b> Walk</li>
        <li><b>Thu</b> Rest / mobility</li>
        <li><b>Fri</b> Strength</li>
        <li><b>Sat</b> Walk</li>
        <li><b>Sun</b> Off</li>
      </ul>
    </div>

    <div class="kpi" id="kpis"></div>

    <div class="card">
      <h2>Quick setup</h2>
      <div class="grid">
        <div class="field sm">
          <label for="profileAge">Age</label>
          <input id="profileAge" type="number" min="1" max="120" />
        </div>
        <div class="field sm">
          <label for="profileStart">Start date</label>
          <input id="profileStart" type="date" />
        </div>
        <div class="field sm">
          <label for="profileGoal">Primary goal</label>
          <select id="profileGoal">
            <option>Fat loss + consistency</option>
            <option>Strength + mobility</option>
            <option>General fitness</option>
            <option>Cardio endurance</option>
          </select>
        </div>
        <div class="field lg">
          <label for="profileNotes">Notes (your “why”)</label>
          <textarea id="profileNotes"></textarea>
        </div>
        <div class="field lg">
          <div class="btnrow">
            <button class="primary" id="saveProfile">Save profile</button>
            <button class="muted" id="fillToday">Set today as start date</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section id="walks" class="panel">
    <div class="card">
      <h2>Add a walk</h2>
      <div class="grid">
        <div class="field sm"><label for="walkDate">Date</label><input id="walkDate" type="date" /></div>
        <div class="field sm"><label for="walkMins">Duration (minutes)</label><input id="walkMins" type="number" min="1" step="1" /></div>
        <div class="field sm"><label for="walkDist">Distance (optional)</label><input id="walkDist" type="text" /></div>
        <div class="field sm"><label for="walkEffort">Effort (1–10)</label><input id="walkEffort" type="number" min="1" max="10" step="1" /></div>
        <div class="field lg"><label for="walkNotes">Notes</label><textarea id="walkNotes"></textarea></div>
        <div class="field lg"><button class="primary" id="addWalk">Add walk</button></div>
      </div>
    </div>

    <div class="card">
      <h2>Walk history</h2>
      <div style="overflow:auto; margin-top:10px;">
        <table id="walkTable"><thead><tr>
          <th>Date</th><th>Minutes</th><th>Distance</th><th>Effort</th><th>Notes</th><th></th>
        </tr></thead><tbody></tbody></table>
      </div>
    </div>
  </section>

  <section id="strength" class="panel">
    <div class="card">
      <h2>Add a strength entry</h2>
      <div class="grid">
        <div class="field sm"><label for="strDate">Date</label><input id="strDate" type="date" /></div>
        <div class="field sm"><label for="strExercise">Exercise</label>
          <select id="strExercise">
            <option>Goblet Squat</option><option>Dumbbell Row</option><option>Dumbbell Chest Press</option>
            <option>Shoulder Press</option><option>Romanian Deadlift</option><option>Farmer’s Carry</option>
            <option>Core (Plank / Dead Bug)</option><option>Other</option>
          </select>
        </div>
        <div class="field sm"><label for="strWeight">Weight used</label><input id="strWeight" type="text" /></div>
        <div class="field sm"><label for="strSets">Sets</label><input id="strSets" type="number" min="1" step="1" value="3" /></div>
        <div class="field sm"><label for="strReps">Reps</label><input id="strReps" type="number" min="1" step="1" /></div>
        <div class="field lg"><label for="strNotes">Notes</label><textarea id="strNotes"></textarea></div>
        <div class="field lg"><button class="primary" id="addStrength">Add strength entry</button></div>
      </div>
    </div>

    <div class="card">
      <h2>Strength history</h2>
      <div style="overflow:auto; margin-top:10px;">
        <table id="strengthTable"><thead><tr>
          <th>Date</th><th>Exercise</th><th>Weight</th><th>Sets</th><th>Reps</th><th>Notes</th><th></th>
        </tr></thead><tbody></tbody></table>
      </div>
    </div>
  </section>

  <section id="pushups" class="panel">
    <div class="card">
      <h2>Push-up progress</h2>
      <div class="grid">
        <div class="field sm"><label for="puDate">Date</label><input id="puDate" type="date" /></div>
        <div class="field sm"><label for="puType">Type</label>
          <select id="puType">
            <option>Wall</option><option>Incline (hands on table/counter)</option><option>Knees</option>
            <option>Full</option><option>Negative (slow lowering)</option>
          </select>
        </div>
        <div class="field sm"><label for="puMax">Max reps (best set)</label><input id="puMax" type="number" min="0" step="1" /></div>
        <div class="field sm"><label for="puTotal">Total reps (all sets)</label><input id="puTotal" type="number" min="0" step="1" /></div>
        <div class="field lg"><label for="puNotes">Notes</label><textarea id="puNotes"></textarea></div>
        <div class="field lg"><button class="primary" id="addPushup">Add push-up entry</button></div>
      </div>
    </div>

    <div class="card">
      <h2>Push-up history</h2>
      <div style="overflow:auto; margin-top:10px;">
        <table id="pushupTable"><thead><tr>
          <th>Date</th><th>Type</th><th>Max</th><th>Total</th><th>Notes</th><th></th>
        </tr></thead><tbody></tbody></table>
      </div>
    </div>
  </section>

  <section id="backup" class="panel">
    <div class="card">
      <h2>Backup / Move to another device</h2>
      <div class="btnrow" style="margin-top:12px;">
        <button class="primary" id="exportBtn">Export data (JSON)</button>
        <label>
          <span class="small" style="display:block; margin-bottom:6px;">Import data (JSON)</span>
          <input id="importFile" type="file" accept="application/json" />
        </label>
      </div>
    </div>

    <div class="card">
      <h2>Danger zone</h2>
      <div class="btnrow" style="margin-top:12px;">
        <button class="danger" id="resetBtn">Reset all data</button>
      </div>
    </div>
  </section>
</main>

<script>
  // --- polyfills / fallbacks ---
  function safeClone(obj){
    try { return (typeof structuredClone === "function") ? structuredClone(obj) : JSON.parse(JSON.stringify(obj)); }
    catch { return JSON.parse(JSON.stringify(obj)); }
  }

  function uuid(){
    try { if (crypto && typeof crypto.randomUUID === "function") return crypto.randomUUID(); } catch {}
    // fallback
    return "id-" + Math.random().toString(16).slice(2) + "-" + Date.now().toString(16);
  }

  const KEY = "fitnessTracker_v1";
  const banner = document.getElementById("errBanner");

  function showBanner(msg){
    banner.textContent = msg;
    banner.style.display = "block";
  }
  function hideBanner(){
    banner.style.display = "none";
    banner.textContent = "";
  }

  const defaultData = {
    profile: { age: 58, startDate: "", goal: "Fat loss + consistency", notes: "" },
    walks: [], strength: [], pushups: []
  };

  function loadData() {
    try {
      const raw = localStorage.getItem(KEY);
      hideBanner();
      return raw ? JSON.parse(raw) : safeClone(defaultData);
    } catch (e) {
      showBanner("Safari is blocking saved data on this device. Turn off Private Browsing / content blockers, then reload.");
      return safeClone(defaultData);
    }
  }

  let data = loadData();

  function trySave(){
    try {
      localStorage.setItem(KEY, JSON.stringify(data));
      hideBanner();
      return true;
    } catch (e) {
      showBanner("Cannot save on this iPhone right now (storage blocked). Exit Private Browsing, disable blockers, then reload.");
      return false;
    }
  }

  function todayISO() {
    const d = new Date();
    const pad = (n) => String(n).padStart(2, "0");
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  }

  function esc(s) {
    return String(s ?? "").replace(/[&<>"']/g, (c) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }

  function removeById(arr, id) {
    const idx = arr.findIndex(x => x.id === id);
    if (idx >= 0) arr.splice(idx, 1);
  }

  function weekStartISO(dateISO) {
    const d = new Date(dateISO + "T00:00:00");
    const day = (d.getDay() + 6) % 7;
    d.setDate(d.getDate() - day);
    return d.toISOString().slice(0,10);
  }

  function inThisWeek(dateISO) {
    const ws = weekStartISO(todayISO());
    const d = new Date(dateISO + "T00:00:00");
    const w = new Date(ws + "T00:00:00");
    const diffDays = Math.floor((d - w) / 86400000);
    return diffDays >= 0 && diffDays < 7;
  }

  function lastNDaysCount(arr, n) {
    const now = new Date(todayISO() + "T00:00:00");
    return arr.filter(x => {
      const d = new Date((x.date || "") + "T00:00:00");
      const diff = Math.floor((now - d) / 86400000);
      return diff >= 0 && diff < n;
    }).length;
  }

  // tabs
  document.querySelectorAll(".tabbtn").forEach(btn => {
    btn.addEventListener("click", () => {
      document.querySelectorAll(".tabbtn").forEach(b => b.classList.remove("active"));
      document.querySelectorAll(".panel").forEach(p => p.classList.remove("active"));
      btn.classList.add("active");
      document.getElementById(btn.dataset.tab).classList.add("active");
      window.scrollTo({ top: 0, behavior: "smooth" });
    });
  });

  // profile bindings
  const profileAge = document.getElementById("profileAge");
  const profileStart = document.getElementById("profileStart");
  const profileGoal = document.getElementById("profileGoal");
  const profileNotes = document.getElementById("profileNotes");

  document.getElementById("fillToday").addEventListener("click", () => { profileStart.value = todayISO(); });

  document.getElementById("saveProfile").addEventListener("click", () => {
    data.profile.age = Number(profileAge.value || 58);
    data.profile.startDate = profileStart.value || "";
    data.profile.goal = profileGoal.value || "Fat loss + consistency";
    data.profile.notes = profileNotes.value || "";
    trySave(); renderAll(); alert("Saved.");
  });

  // add walk
  document.getElementById("walkDate").value = todayISO();
  document.getElementById("addWalk").addEventListener("click", () => {
    const entry = {
      id: uuid(),
      date: document.getElementById("walkDate").value || todayISO(),
      mins: Number(document.getElementById("walkMins").value || 0),
      dist: document.getElementById("walkDist").value || "",
      effort: Number(document.getElementById("walkEffort").value || 0),
      notes: document.getElementById("walkNotes").value || ""
    };
    if (!entry.mins) return alert("Add walk duration (minutes).");
    data.walks.unshift(entry);
    document.getElementById("walkMins").value = "";
    document.getElementById("walkDist").value = "";
    document.getElementById("walkEffort").value = "";
    document.getElementById("walkNotes").value = "";
    trySave(); renderAll();
  });

  // add strength
  document.getElementById("strDate").value = todayISO();
  document.getElementById("addStrength").addEventListener("click", () => {
    const entry = {
      id: uuid(),
      date: document.getElementById("strDate").value || todayISO(),
      exercise: document.getElementById("strExercise").value || "",
      weight: document.getElementById("strWeight").value || "",
      sets: Number(document.getElementById("strSets").value || 0),
      reps: Number(document.getElementById("strReps").value || 0),
      notes: document.getElementById("strNotes").value || ""
    };
    if (!entry.exercise) return alert("Pick an exercise.");
    if (!entry.sets || !entry.reps) return alert("Add sets and reps.");
    data.strength.unshift(entry);
    document.getElementById("strWeight").value = "";
    document.getElementById("strReps").value = "";
    document.getElementById("strNotes").value = "";
    trySave(); renderAll();
  });

  // add pushups
  document.getElementById("puDate").value = todayISO();
  document.getElementById("addPushup").addEventListener("click", () => {
    const entry = {
      id: uuid(),
      date: document.getElementById("puDate").value || todayISO(),
      type: document.getElementById("puType").value || "",
      max: Number(document.getElementById("puMax").value || 0),
      total: Number(document.getElementById("puTotal").value || 0),
      notes: document.getElementById("puNotes").value || ""
    };
    if (!entry.type) return alert("Pick a push-up type.");
    if (!entry.max && !entry.total) return alert("Add max reps or total reps.");
    data.pushups.unshift(entry);
    document.getElementById("puMax").value = "";
    document.getElementById("puTotal").value = "";
    document.getElementById("puNotes").value = "";
    trySave(); renderAll();
  });

  function renderWalks() {
    const tb = document.querySelector("#walkTable tbody");
    tb.innerHTML = "";
    for (const w of data.walks) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${esc(w.date)}</td><td>${esc(w.mins)}</td><td>${esc(w.dist)}</td>
        <td>${esc(w.effort || "")}</td><td>${esc(w.notes)}</td>
        <td><div class="row-actions"><button class="muted" data-delwalk="${esc(w.id)}">Delete</button></div></td>`;
      tb.appendChild(tr);
    }
    tb.querySelectorAll("[data-delwalk]").forEach(btn => {
      btn.addEventListener("click", () => {
        if (!confirm("Delete this walk?")) return;
        removeById(data.walks, btn.dataset.delwalk);
        trySave(); renderAll();
      });
    });
  }

  function renderStrength() {
    const tb = document.querySelector("#strengthTable tbody");
    tb.innerHTML = "";
    for (const s of data.strength) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${esc(s.date)}</td><td>${esc(s.exercise)}</td><td>${esc(s.weight)}</td>
        <td>${esc(s.sets)}</td><td>${esc(s.reps)}</td><td>${esc(s.notes)}</td>
        <td><div class="row-actions"><button class="muted" data-delstr="${esc(s.id)}">Delete</button></div></td>`;
      tb.appendChild(tr);
    }
    tb.querySelectorAll("[data-delstr]").forEach(btn => {
      btn.addEventListener("click", () => {
        if (!confirm("Delete this strength entry?")) return;
        removeById(data.strength, btn.dataset.delstr);
        trySave(); renderAll();
      });
    });
  }

  function renderPushups() {
    const tb = document.querySelector("#pushupTable tbody");
    tb.innerHTML = "";
    for (const p of data.pushups) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${esc(p.date)}</td><td>${esc(p.type)}</td><td>${esc(p.max)}</td>
        <td>${esc(p.total)}</td><td>${esc(p.notes)}</td>
        <td><div class="row-actions"><button class="muted" data-delpu="${esc(p.id)}">Delete</button></div></td>`;
      tb.appendChild(tr);
    }
    tb.querySelectorAll("[data-delpu]").forEach(btn => {
      btn.addEventListener("click", () => {
        if (!confirm("Delete this push-up entry?")) return;
        removeById(data.pushups, btn.dataset.delpu);
        trySave(); renderAll();
      });
    });
  }

  function renderProfile() {
    profileAge.value = data.profile.age ?? 58;
    profileStart.value = data.profile.startDate ?? "";
    profileGoal.value = data.profile.goal ?? "Fat loss + consistency";
    profileNotes.value = data.profile.notes ?? "";
    document.getElementById("walkDate").value ||= todayISO();
    document.getElementById("strDate").value ||= todayISO();
    document.getElementById("puDate").value ||= todayISO();
  }

  function renderKPIs() {
    const el = document.getElementById("kpis");
    const walksThisWeek = data.walks.filter(w => w.date && inThisWeek(w.date)).length;
    const strengthThisWeek = data.strength.filter(s => s.date && inThisWeek(s.date)).length;
    const walks7 = lastNDaysCount(data.walks, 7);
    const strength7 = lastNDaysCount(data.strength, 7);
    const bestFull = Math.max(0, ...data.pushups.filter(p => p.type === "Full").map(p => Number(p.max || 0)));
    const bestAny = Math.max(0, ...data.pushups.map(p => Number(p.max || 0)));
    el.innerHTML = `
      <div class="box"><h3>Walks this week (goal 3)</h3><div class="num">${walksThisWeek}</div><div class="small">Last 7 days: ${walks7}</div></div>
      <div class="box"><h3>Strength entries this week</h3><div class="num">${strengthThisWeek}</div><div class="small">Last 7 days: ${strength7}</div></div>
      <div class="box"><h3>Push-up best (Any / Full)</h3><div class="num">${bestAny} / ${bestFull}</div><div class="small">Log small sessions. Momentum wins.</div></div>
    `;
  }

  function renderAll() {
    renderProfile(); renderKPIs(); renderWalks(); renderStrength(); renderPushups();
  }

  // backup
  document.getElementById("exportBtn").addEventListener("click", () => {
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `fitness-tracker-backup-${todayISO()}.json`;
    a.click();
    URL.revokeObjectURL(a.href);
  });

  document.getElementById("importFile").addEventListener("change", async (e) => {
    const file = e.target.files?.[0];
    if (!file) return;
    try {
      const imported = JSON.parse(await file.text());
      data = {
        profile: imported.profile ?? safeClone(defaultData.profile),
        walks: Array.isArray(imported.walks) ? imported.walks : [],
        strength: Array.isArray(imported.strength) ? imported.strength : [],
        pushups: Array.isArray(imported.pushups) ? imported.pushups : []
      };
      trySave(); renderAll(); alert("Imported successfully.");
      e.target.value = "";
    } catch {
      alert("Import failed.");
      e.target.value = "";
    }
  });

  document.getElementById("resetBtn").addEventListener("click", () => {
    if (!confirm("Wipe all data on this device/browser?")) return;
    data = safeClone(defaultData);
    trySave(); renderAll();
    alert("Reset complete.");
  });

  if (!data.profile.startDate) data.profile.startDate = todayISO();
  trySave();
  renderAll();
</script>
</body>
</html>
